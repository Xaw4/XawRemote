print("Starting xawremote... ")
serverUrl = "http://localhost:8888/"

function sendRequest(retValue)
        local label = os.getComputerLabel()
		retValue = retValue or "null"
		local request = serverUrl..label.."?param="..retValue
		print("-- send request:")
		print(request)
		http.request(request)
end
function encode (s)
  s = string.gsub(s, "([?&=+%c])", function (c)
		return string.format("%%%02X", string.byte(c))
	  end)
  s = string.gsub(s, " ", "+")
  return s
end
function wait()
        print("nothing to do here .. ")
        os.sleep(1)
end
 
function waitForAnswer()
        while true do
                local event, host, params = os.pullEvent()
                if event == "http_failure" then
                        wait()
                        sendRequest("waiting")
                else
                   if event == "http_success" then
				   
						output = "success"
                        if program == "wait" then
                                wait()
                        else
							param = params.readAll()
							-- print ("host: "..host.." params: "..param)
							f = assert(loadstring(param, output))
							
							local status = {pcall(f)}
							if status[1] then 
								print("successfully called f")
							else
								print("'"..status[2].."'")
								-- print(status[3])
								output = "error:"..encode(status[2])
							end
							print(output)
                        end
                        sendRequest(output)
                  end
                end
        end
end
 
sendRequest("first")
waitForAnswer()